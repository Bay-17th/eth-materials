# 5주차: PoS/Consensus 상세 설명

합의 메커니즘, 지분증명, 검증자를 처음 배우는 분들을 위한 상세 설명입니다.

---

## 1. 비유로 시작하기

합의 메커니즘을 이해하는 가장 쉬운 방법은 **투표**를 떠올리는 것입니다.

### 투표로 생각하기

학급 회장 선거를 생각해봅시다:
1. **여러 후보**가 있습니다 (여러 블록)
2. **투표**로 한 명을 선택합니다 (합의)
3. **당선자**가 결정됩니다 (정규 블록)

> 이더리움도 마찬가지예요.
> 여러 블록 중 "어떤 블록이 맞는지" 투표로 결정합니다!

---

## 2. 합의 = 다수결 결정

### 왜 합의가 필요한가요?

이더리움은 **분산 네트워크**입니다:
- 전 세계에 수천 개의 노드가 있습니다
- 중앙 서버가 없습니다
- 누가 "정답"을 알려줄 수 없습니다

**문제 상황:**
```
노드 A: "블록 100은 이거야!"
노드 B: "아니, 블록 100은 저거야!"
노드 C: "둘 다 아닌데?"
```

**해결책:** 모든 노드가 같은 규칙으로 결정 = **합의 메커니즘**

### Byzantine Fault Tolerance (BFT)

**비잔틴 장군 문제:**
- 여러 장군이 공격 시간을 합의해야 합니다
- 일부 장군은 **배신자**입니다 (거짓 메시지 전달)
- 정직한 장군들만으로 합의가 가능할까요?

**해결 조건:**
- 참여자의 **2/3 이상**이 정직하면 합의 가능
- 이더리움도 이 원리를 사용합니다

> 배신자가 1/3 미만이면, 정직한 사람들끼리 항상 합의할 수 있어요!

---

## 3. PoW에서 PoS로 전환

### PoW (Proof of Work, 작업 증명)

**어떻게 동작하나요?**
- 어려운 **수학 문제**를 풉니다
- 문제를 **가장 먼저 푼** 노드가 블록 생성
- 엄청난 계산 능력(해시파워)이 필요

**비유:** 금 채굴
- 금을 캐려면 많은 노력(에너지)이 필요
- 더 좋은 장비가 있으면 더 많이 캘 수 있음

**문제점:**
- **엄청난 에너지 소비** (소규모 국가 수준)
- 전문 채굴 장비에 집중화

### PoS (Proof of Stake, 지분 증명)

**어떻게 동작하나요?**
- ETH를 **스테이킹**(예치)합니다
- 무작위로 **블록 제안자** 선택
- 다른 검증자들이 **투표**로 확인

**비유:** 주주 총회
- 주식(지분)을 가진 사람이 투표권을 가짐
- 더 많은 주식 = 더 많은 영향력

**장점:**
- **에너지 99.95% 절감**
- 누구나 32 ETH만 있으면 참여 가능

### The Merge (2022.9.15)

이더리움이 PoW에서 PoS로 전환한 역사적 사건입니다:
- 2020년 12월: Beacon Chain 출시
- 테스트넷에서 충분한 검증
- 2022년 9월 15일: **The Merge** 완료!

> 블록체인 역사상 가장 큰 업그레이드였어요!

---

## 4. 검증자 = 투표권자

### 검증자(Validator)란?

**검증자**는 이더리움의 PoS 시스템에 참여하는 사람입니다.

**비유:** 배심원
- 보증금(32 ETH)을 내고 참여
- 블록이 유효한지 판단
- 성실히 참여하면 보상, 나쁜 행동하면 처벌

### 어떻게 검증자가 되나요?

1. **32 ETH 준비** (보증금)
2. **스테이킹 컨트랙트**에 입금
3. **검증자 클라이언트** 소프트웨어 실행
4. **활성화 큐** 대기 (약 1일)
5. 활성화되면 **블록 검증** 시작!

### 검증자의 두 가지 역할

**1. 블록 제안자(Proposer)**
- 슬롯마다 **1명**만 선택됨
- 새 블록을 만들어 제안
- 성공하면 추가 보상!

**2. 증명자(Attester)**
- 제안된 블록을 **검증**
- "이 블록이 유효해요"라고 투표
- 매 에폭마다 참여

### 보상과 패널티

**보상 (연간 약 4-7% APR):**
| 활동 | 보상 |
|------|------|
| 블록 제안 | 높음 |
| 증명 참여 | 일반 |
| 동기화 위원회 | 보너스 |

**패널티:**
| 상황 | 결과 |
|------|------|
| 오프라인 | 소액 손실 |
| 잘못된 증명 | 패널티 |
| 악의적 행위 | **슬래싱** (큰 손실) |

---

## 5. RANDAO = 공정한 추첨

### 왜 무작위가 필요한가요?

**문제:** 다음 블록 제안자가 예측 가능하면?
- 공격자가 그 검증자를 미리 공격할 수 있음
- DDoS 공격으로 블록 생성 방해

**해결:** 예측 불가능한 무작위 선택!

### RANDAO 동작 원리

**RANDAO**는 검증자들의 기여를 조합해서 무작위 값을 만듭니다.

```
검증자 1: 무작위 값 r1 제출
검증자 2: 무작위 값 r2 제출
검증자 3: 무작위 값 r3 제출
...

최종 Mix = r1 XOR r2 XOR r3 XOR ...
```

**XOR(배타적 논리합):**
- 입력 중 하나만 달라도 결과가 완전히 달라짐
- 모든 검증자의 기여가 결과에 영향

### 왜 안전한가요?

1. **예측 불가:** 마지막 기여자도 결과를 알 수 없음
2. **편향 저항:** 한 명이 조작해도 결과 완전 통제 불가
3. **검증 가능:** 모든 기여가 블록에 기록되어 확인 가능

**비유:** 여러 사람이 동시에 주사위 던지기
- 각자 주사위를 던짐
- 모든 결과를 조합해서 최종 숫자 결정
- 한 명이 원하는 숫자가 나오게 조작하기 불가능

---

## 6. 슬래싱 = 부정행위 처벌

### 슬래싱(Slashing)이란?

**슬래싱**은 규칙을 위반한 검증자에 대한 강력한 처벌입니다.

**비유:** 배심원 매수
- 배심원이 돈을 받고 거짓 판결을 하면?
- 벌금 + 자격 박탈!

### 어떤 행위가 슬래싱 대상인가요?

**1. Double Voting (이중 투표)**
- 같은 슬롯에 **두 개의 다른 블록**에 투표
- "A도 맞고 B도 맞아요"는 안 됨!

**2. Surround Voting (둘러싸기 투표)**
- 이전 증명을 둘러싸는 새 증명
- 시간 조작 시도로 간주

### 슬래싱의 결과

| 상황 | 손실 |
|------|------|
| 개인 실수 | 최소 1 ETH |
| 대규모 공격 (여러 검증자 동시) | 최대 **전체 지분** |

**왜 규모에 따라 다른가요?**
- 개인 실수: 가벼운 처벌 (실수는 있을 수 있음)
- 조직적 공격: 치명적 처벌 (공격 억제)

> 동시에 많은 검증자가 슬래싱되면, "조직적 공격"으로 간주해서 더 강하게 처벌해요!

### 슬래싱 후에는?

1. 지분 일부 **즉시 소각**
2. **강제 퇴장** 프로세스 시작
3. 대기 기간 동안 **추가 패널티** 가능
4. 출금까지 약 **36일** 소요

---

## 7. 핵심 요약

1. **합의 = 분산 네트워크에서 진실 결정**
   - Byzantine Fault Tolerance
   - 2/3 이상이 정직하면 합의 가능

2. **PoS = 지분 증명**
   - 32 ETH 스테이킹으로 참여
   - 에너지 99.95% 절감 (vs PoW)

3. **검증자 = 이더리움의 투표권자**
   - 블록 제안 + 증명
   - 보상(4-7% APR)과 패널티

4. **RANDAO = 공정한 무작위 선택**
   - 모든 검증자 기여 조합
   - 예측/조작 불가능

5. **슬래싱 = 부정행위 처벌**
   - Double voting, Surround voting
   - 지분 손실 + 강제 퇴장

---

## 8. 다음 단계

### 이 주의 다른 자료

- [slides.md](./slides.md) - 발표용 슬라이드
- [용어 사전](../../resources/glossary.md) - 이번 주 핵심 용어

### 다음 주 예고

**6주차: Beacon Chain/Finality**

- Beacon Chain이란?
- Slot과 Epoch 개념
- Finality(최종성) 달성
- Casper FFG와 LMD-GHOST

### 더 알고 싶다면

- [Ethereum.org - Proof of Stake](https://ethereum.org/developers/docs/consensus-mechanisms/pos)
- [Ethereum.org - The Merge](https://ethereum.org/roadmap/merge)
- [Staking on Ethereum](https://ethereum.org/staking)

---

## 용어 정리

| 용어 | 설명 |
|------|------|
| Consensus | 분산 네트워크에서 합의에 도달하는 방식 |
| PoW | Proof of Work, 작업 증명 (채굴) |
| PoS | Proof of Stake, 지분 증명 (스테이킹) |
| Staking | ETH를 예치하여 검증자가 되는 것 |
| Validator | 블록을 검증하고 제안하는 참여자 |
| Proposer | 블록을 제안하는 검증자 |
| Attester | 블록을 증명하는 검증자 |
| RANDAO | 분산 무작위 수 생성 방식 |
| Slashing | 규칙 위반 검증자에 대한 처벌 |
| Double Voting | 같은 슬롯에 두 번 투표 (슬래싱 대상) |
| Surround Voting | 이전 증명을 둘러싸는 투표 (슬래싱 대상) |
| BFT | Byzantine Fault Tolerance |
| The Merge | PoW에서 PoS로 전환 (2022.9.15) |

> 더 많은 용어는 [용어 사전](../../resources/glossary.md)을 참고하세요!
