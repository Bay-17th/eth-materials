# 1주차: State/Account 상세 설명

이더리움의 기본 구조를 처음 배우는 분들을 위한 상세 설명입니다.

---

## 1. 비유로 시작하기

이더리움을 이해하는 가장 쉬운 방법은 **ATM 기계**를 떠올리는 것입니다.

### ATM 기계의 동작 방식

1. **현재 상태**: 내 계좌에 100만원이 있습니다
2. **입력**: 50만원 출금 버튼을 누릅니다
3. **처리**: ATM이 요청을 확인하고 처리합니다
4. **새로운 상태**: 내 계좌에 50만원이 남습니다

이 과정을 **상태 전이(State Transition)**라고 합니다.

> 이더리움도 마치 거대한 ATM처럼 동작합니다.
> 트랜잭션(입력)이 들어오면 → 처리하고 → 새로운 상태가 됩니다.

---

## 2. 상태 머신 (State Machine)

### 상태 머신이란?

**상태 머신**은 "현재 상태"와 "입력"에 따라 "다음 상태"가 결정되는 시스템입니다.

예를 들어, 자판기도 상태 머신입니다:

| 현재 상태 | 입력 | 다음 상태 |
|-----------|------|-----------|
| 대기 중 | 1000원 투입 | 1000원 보유 |
| 1000원 보유 | 음료 선택 | 음료 배출 |
| 음료 배출 | 음료 수령 | 대기 중 |

### 이더리움의 상태 머신

이더리움에서:

- **현재 상태(σ_t)**: 모든 계정의 잔액, 코드, 데이터
- **입력(Transaction)**: 누군가 보낸 트랜잭션
- **다음 상태(σ_t+1)**: 트랜잭션 적용 후의 새로운 상태

수식으로 표현하면: `Y(S, TX) = S'`

### 왜 중요한가?

상태 머신으로 이해하면:

1. **예측 가능**: 같은 입력 = 같은 결과
2. **검증 가능**: 누구나 결과를 확인할 수 있습니다
3. **합의 가능**: 모든 노드가 같은 상태에 도달합니다

---

## 3. 계정의 두 종류

이더리움에는 **두 종류**의 계정이 있습니다.

### EOA: 외부 소유 계정 (Externally Owned Account)

**비유: "내 지갑"**

EOA는 여러분이 직접 제어하는 계정입니다. 마치 여러분만 열 수 있는 지갑처럼요.

**특징:**
- **개인키(Private Key)**가 있어야 사용할 수 있습니다
- **트랜잭션을 시작**할 수 있습니다 (유일하게!)
- 코드가 없습니다

**실제 예시:**
- MetaMask 지갑
- Ledger/Trezor 하드웨어 지갑
- 거래소에서 생성한 개인 계정

### CA: 컨트랙트 계정 (Contract Account)

**비유: "자동 금고"**

CA는 스마트 컨트랙트가 제어하는 계정입니다. 마치 정해진 규칙대로만 열리는 금고처럼요.

**특징:**
- **코드(Smart Contract)**로 제어됩니다
- 트랜잭션을 **시작할 수 없습니다** (반드시 EOA가 먼저 호출해야 함)
- **스토리지(Storage)**에 데이터를 저장할 수 있습니다

**실제 예시:**
- Uniswap (탈중앙화 거래소)
- USDT, USDC 같은 토큰 컨트랙트
- OpenSea의 NFT 컨트랙트

### 핵심 차이 정리

| 구분 | EOA | CA |
|------|-----|-----|
| 제어 방법 | 개인키 | 코드 |
| TX 시작 | **가능** | 불가 |
| 코드 보유 | 없음 | **있음** |
| 스토리지 | 없음 | **있음** |
| 생성 방법 | 키 생성 | 배포 TX |

> **기억하세요**: 모든 트랜잭션의 시작은 EOA입니다!
> CA는 호출을 받았을 때만 동작합니다.

---

## 4. 계정이 가지고 있는 것들

모든 계정(EOA와 CA 모두)은 **4가지 정보**를 가집니다.

### nonce (논스) - "트랜잭션 번호표"

**논스(nonce)**는 트랜잭션 순서를 보장하는 번호입니다.

- **EOA**: 보낸 트랜잭션의 수
- **CA**: 생성한 컨트랙트의 수

**왜 필요한가?**

은행에서 번호표를 뽑으면 순서대로 처리되잖아요? 논스도 마찬가지입니다.

```
논스 = 5인 트랜잭션을 보내면
→ 논스 4까지의 트랜잭션이 먼저 처리되어야 합니다
→ 순서가 보장됩니다!
```

또한 **재실행 공격(Replay Attack)**을 막아줍니다.

### balance (잔액) - "보유 이더"

계정이 가진 **이더(ETH)**의 양입니다.

- 단위: **Wei** (이더리움의 가장 작은 단위)
- 1 ETH = 1,000,000,000,000,000,000 Wei (10^18)

**비유**: 은행 계좌의 잔액과 같습니다.

### storageRoot (저장소 루트) - "금고 열쇠"

**CA(컨트랙트)만** 해당됩니다.

컨트랙트가 저장한 데이터(변수들)의 **Merkle Patricia Trie 루트**입니다.

**비유**: 금고 안에 뭐가 있는지 한눈에 확인할 수 있는 목록의 "지문"

- EOA는 저장할 데이터가 없으므로 비어있습니다
- 4주차에서 MPT를 자세히 배웁니다

### codeHash (코드 해시) - "규칙서 지문"

컨트랙트 **코드의 해시값**입니다.

- **CA**: 스마트 컨트랙트 코드의 Keccak-256 해시
- **EOA**: 빈 문자열의 해시값

**비유**: 계약서의 지문 - 누군가 계약서(코드)를 바꾸면 지문이 달라집니다.

> 코드는 한 번 배포되면 **변경할 수 없습니다**!
> (Proxy 패턴을 쓰면 우회 가능하지만, 5주차에서 배웁니다)

---

## 5. World State = 거대한 주소록

### World State란?

**월드 스테이트(World State)**는 이더리움의 **모든 계정 상태**를 담고 있는 거대한 데이터베이스입니다.

**비유**: 전화번호부

| 주소 | 이름 | 전화번호 |
|------|------|----------|
| 강남구 | 홍길동 | 010-1234-5678 |
| 서초구 | 김철수 | 010-9876-5432 |

이더리움의 World State:

| 주소 | nonce | balance | storageRoot | codeHash |
|------|-------|---------|-------------|----------|
| 0x123... | 5 | 1 ETH | - | - |
| 0x456... | 0 | 0 | 0xabc... | 0xdef... |

### 어떻게 저장되나요?

**Merkle Patricia Trie(MPT)**라는 특별한 자료구조로 저장됩니다.

MPT의 장점:

1. **빠른 검색**: 주소로 계정 정보를 빠르게 찾습니다
2. **효율적 저장**: 공간을 절약합니다 (Patricia)
3. **변조 방지**: 해시로 무결성을 검증합니다 (Merkle)

> MPT는 4주차에서 자세히 배웁니다!
> 지금은 "빠르고 안전한 전화번호부"라고 생각하세요.

### State Root

World State 전체를 대표하는 하나의 해시값을 **State Root**라고 합니다.

- 모든 블록 헤더에 포함됩니다
- 이 값이 같으면 = 상태가 같습니다
- 블록 검증에 사용됩니다

---

## 6. 핵심만 기억하세요

1. **이더리움 = 상태 머신**
   - 트랜잭션이 상태를 변경합니다
   - 모든 노드가 같은 상태를 공유합니다

2. **계정 두 종류**
   - EOA: 개인키, TX 시작 가능 (내 지갑)
   - CA: 코드, TX 시작 불가 (자동 금고)

3. **계정 상태 4가지**
   - nonce: 트랜잭션 번호표
   - balance: 잔액
   - storageRoot: 저장소 루트 (CA만)
   - codeHash: 코드 해시

4. **World State**
   - 모든 계정의 현재 상태
   - MPT로 저장 (빠름 + 안전)

---

## 7. 다음 단계

### 이 주의 다른 자료

- [slides.md](./slides.md) - 발표용 슬라이드
- [용어 사전](../../resources/glossary.md) - 이번 주 핵심 용어

### 다음 주 예고

**2주차: Transaction/Signature**

- 트랜잭션의 구조는 어떻게 되나요?
- 서명(Signature)은 어떻게 만드나요?
- 가스(Gas)는 무엇이고 왜 필요한가요?

### 더 알고 싶다면

- [Ethereum.org - Accounts](https://ethereum.org/developers/docs/accounts)
- [Ethereum Whitepaper](https://ethereum.org/whitepaper)

---

## 용어 정리

| 용어 | 설명 |
|------|------|
| State Machine | 입력에 따라 상태가 변하는 시스템 |
| EOA | 개인키로 제어하는 외부 소유 계정 |
| CA | 코드로 제어하는 컨트랙트 계정 |
| nonce | 트랜잭션 순서 번호 |
| balance | 계정 잔액 (Wei 단위) |
| storageRoot | 컨트랙트 저장소의 루트 해시 |
| codeHash | 컨트랙트 코드의 해시값 |
| World State | 모든 계정 상태의 집합 |
| MPT | Merkle Patricia Trie (자료구조) |
| State Root | World State의 루트 해시 |

> 더 많은 용어는 [용어 사전](../../resources/glossary.md)을 참고하세요!
